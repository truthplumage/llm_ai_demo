# [이론3] 할루시네이션과 Context

## 정의와 원인
- **할루시네이션**: 모델이 근거 없는 정보를 그럴듯하게 생성하는 현상.
- 주된 원인
  - 학습 데이터에 없는 최신/도메인 지식 질의
  - 입력 컨텍스트 부족 또는 모호한 지침
  - 높은 샘플링 온도, 과도한 생성 길이
  - 모델의 잘못된 추론/환각 후 자기 일관성 유지

## 완화 전략
- **정확한 프롬프트 설계**: 시스템 메시지로 역할·제약 명시, "모르면 모른다고 답변" 지시, 금지사항/포맷 강제.
- **구조화된 출력 강제**: JSON 스키마, 함수 호출(tool call)로 필드·타입을 강제해 후처리/검증 가능.
- **컨텍스트 강화(RAG)**: 관련 문서를 검색해 증거를 함께 제공. 근거를 인용하거나 근거 부족 시 거부하도록 지시.
- **샘플링 제어**: temperature/top_p를 낮춰 일관성↑, `max_tokens`로 불필요한 장문 생성 제한.
- **후처리 검증**: 스키마 검증, 정규식/비즈니스 룰 체크, 지식 베이스와 교차 검증.
- **다중 호출 합의**: Self-consistency(여러 샘플 중 다수결), ReAct/검색-답변 루프.

## 컨텍스트 전달 패턴
- **시스템·사용자·도우미 메시지 분리**: 역할/규칙은 system, 질문은 user, 이전 대화는 assistant 메시지로 명확히 관리.
- **길이 관리**: 오래된 대화는 요약 후 유지. 슬라이딩 윈도우로 최근 컨텍스트만 유지.
- **검색 증거 포함**: RAG로 `source`, `quote`, `url`을 포함한 JSON 컨텍스트를 전달하고, 응답에서도 인용하도록 지시.
- **장바구니/사용자 속성 전달**: 구조화 JSON으로 전달해 파싱·검증 가능하게 유지.

## 프롬프트 예시
- 시스템: "너는 쇼핑 추천 엔진이다. 근거가 없으면 `"reason":"no evidence"`로 응답하고, 지정된 JSON 스키마를 준수해라."
- 사용자: `장바구니: {cartJson}. 최근 검색어: {queries}. 응답 스키마: {schema}`
- 기대 출력 (예):
```json
{
  "reason": "최근 검색과 유사한 전자책 리더기 추천",
  "queryTerm": "전자책 리더기 방수 경량"
}
```

## 평가와 모니터링
- **오프라인 평가**: 정답 레이블이 있는 질의-문서 셋으로 RAG+LLM 응답을 평가(BLEU/ROUGE는 부적합, 대신 정확도·F1·스키마 일치율·출처 인용 여부 확인).
- **휴리스틱 검사**: 응답에 금지 단어/PII/허위 출처가 포함되는지 검사.
- **온라인 관측**: latency, 토큰 사용량, 응답 거절률, 스키마 오류율, 사용자 피드백/신고율 추적.
- **A/B 테스트**: 프롬프트/모델/샘플링 옵션을 변경해 품질·비용 최적화.
